# Autogenerated from template.yml. Changes will be lost.

version: 2.1

orbs:
  windows: circleci/windows@2.4.0

workflows:
  version: 2
  win2019:
    when:
      equal: [ 3139ac81b2374b261e778050757b729d6df3d57b, << pipeline.git.base_revision >> ]
    jobs:
      - test:
          filters:
            branches:
              only:
                - circleci-project-setup
                - master
                - release-candidate
                - test-windows
  no_workflow:
    when:
      not:
        equal: [ 3139ac81b2374b261e778050757b729d6df3d57b, << pipeline.git.base_revision >> ]
    jobs:
      - do_nothing_job


jobs:
  do_nothing_job:
    docker: [ image: cimg/base:2020.01 ]
    steps:
      - checkout

  test:

    executor: { name: windows/default }

#    environment:
#      # Customize the JVM maximum heap limit
#      JVM_OPTS: -Xmx3200m
#      TERM: dumb

    steps:
      - checkout

      # Download and cache Isabelle
      - restore_cache:
          keys:
            - v2-isabelle-2019-windows
      - run:
          name: Downloading Isabelle 2019 (if needed)
          shell: bash
          command: |
            if ! [ -e "$HOME/install/Isabelle2019" ]; then
              mkdir -p ~/install
              case windows in
                windows)
                  curl "https://isabelle.in.tum.de/website-Isabelle2019/dist/Isabelle2019.exe" -o /tmp/isabelle.exe
                  7z x -y -o"$HOME/install" /tmp/isabelle.exe;;
                linux)
                  curl https://isabelle.in.tum.de/website-Isabelle2019/dist/Isabelle2019_linux.tar.gz | tar -x -z -C ~/install;;
              esac
            fi
      - save_cache:
          paths:
            - ~/install/Isabelle2019
          key: v2-isabelle-2019-windows

      # Download and cache dependencies
      - restore_cache:
          keys:
            - v3-dependencies-windows-{{ checksum "build.sbt" }}-{{ checksum "publish.sbt" }}
            - v3-dependencies-windows-
      - run:
          name: Downloading build dependencies (if needed)
          shell: bash
          command: |
            if ! sha1sum -c ~/dependencies-sha1sum; then
              mkdir -p ~/install
              curl -Ls https://git.io/sbt > ~/install/sbt
              chmod +x ~/install/sbt
              ~/install/sbt update test/update </dev/null
            fi
            sha1sum build.sbt publish.sbt > ~/dependencies-sha1sum
      - save_cache:
          paths:
            - ~/install/sbt
            - ~/.m2
            - ~/.sbt
            - ~/.ivy2
            - $LOCALAPPDATA\Coursier\Cache
            - ~/.cache/coursier
            - ~/dependencies-sha1sum
          key: v3-dependencies-windows-{{ checksum "build.sbt" }}-{{ checksum "publish.sbt" }}

      - run:
          name: Running tests
          shell: bash
          command: |
            case windows in
              windows)
                # Isabelle process calls rebaseall and then fails, unless we deactivate it
                > ~/install/Isabelle2019/contrib/cygwin/isabelle/rebaseall
                cygpath -w ~/install/Isabelle2019 > .isabelle-home;;
              linux)
                echo ~/install/Isabelle2019 > .isabelle-home;;
            esac

            # Failure only happens with Isabelle 2019

            # Things to try:
            # - configuring how sbt runs tests (no forking, spawning)
            # - login bash with cleared env (need HOME though)
            # - nohup
            # no </dev/null
            # use a different sbt (choco install sbt)
            # run sbt in CMD
            # test whether sbt works via ssh if we do not run it here (maybe only first sbt fails)

            #which bash
            #            env -i HOME=~ /bin/bash --login ~/install/sbt "testOnly -- -u scalatest-reports"    # Doesn't initialize like login shell...
            choco install sbt

            #~/install/Isabelle2020/contrib/cygwin/bash ~/install/Isabelle2020/bin/isabelle process -e 1

            #~/install/sbt "testOnly -- -u scalatest-reports" </dev/null

      # Is this true for 2019?
      # Failure reproduceable via: (no sbt run in circle-ci-jobs), ssh cmd, refreshenv (requires: choco install sbt), cd project, sbt test
      # First run only! Repeated run succeed.

      - run:
          shell: cmd.exe
          command: refreshenv & sbt test

      - store_test_results:
          path: scalatest-reports